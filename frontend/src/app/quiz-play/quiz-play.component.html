<!-- [A] Header Area -->
<mat-toolbar color="primary" class="header">
  <div class="quiz-info">
    <span>ジャンル: {{ quizState.genre() }}</span>
    <span class="separator">/</span>
    <span>難易度: {{ quizState.difficulty() }}</span>
  </div>
  <span class="spacer"></span>
  <button mat-button (click)="addUser()">
    <mat-icon>person_add</mat-icon>
    ユーザーを追加する
  </button>
  <button mat-button (click)="backToSettings()">
    <mat-icon>settings</mat-icon>
    設定に戻る
  </button>
  <button mat-button (click)="resetGame()">
    <mat-icon>restart_alt</mat-icon>
    ゲームをリセット
  </button>
</mat-toolbar>

<div class="container">
  <!-- Turn Display -->
  @if (quizState.gameMode() === 'turn' && playerState.currentPlayer(); as player) {
    <div class="turn-display">
      <h2>次は <span class="player-icon-small">{{ player.icon }}</span> {{ player.name }} さんの番です</h2>
    </div>
  }

  <!-- [B] Quiz Area -->
  <main class="quiz-area">
    @switch (viewState()) {
      @case ('loading') {
        <div class="loading-container">
          <mat-progress-spinner mode="indeterminate" [diameter]="80"></mat-progress-spinner>
          <p>AIがクイズを作成中です...</p>
        </div>
      }
      @case ('quiz') {
        <mat-card class="quiz-card">
          @if (quizState.quiz(); as quiz) {
            <mat-card-header>
              <mat-card-title class="question">{{ quiz.question }}</mat-card-title>
            </mat-card-header>
            <mat-card-content class="options">
              @for (option of quiz.options; track option) {
                <button mat-raised-button class="option-btn" (click)="selectAnswer(option)">
                  {{ option }}
                </button>
              }
            </mat-card-content>
            <mat-card-actions class="hint-section">
              @if (quizState.hint(); as hint) {
                <p class="hint-text"><strong>ヒント:</strong> {{ hint.hint }}</p>
              } @else {
                <button mat-stroked-button color="accent" (click)="fetchHint()">
                  <mat-icon>lightbulb</mat-icon>
                  ヒントを見る
                </button>
              }
            </mat-card-actions>
          }
        </mat-card>
      }
      @case ('answer') {
        <mat-card class="quiz-card">
          @if (quizState.quiz(); as quiz) {
            <mat-card-header>
              <mat-card-title class="question">{{ quiz.question }}</mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <div class="options">
                @for (option of quiz.options; track option) {
                  <button
                    mat-raised-button
                    class="option-btn"
                    [color]="option === quiz.correctAnswer ? 'primary' : (option === selectedAnswer() ? 'warn' : undefined)"
                    [disabled]="true"
                  >
                    {{ option }}
                  </button>
                }
              </div>
              <div class="explanation">
                <h3>
                  @if (selectedAnswer() === quiz.correctAnswer) {
                    <span class="correct-text"><mat-icon>check_circle</mat-icon> 正解！</span>
                  } @else {
                    <span class="incorrect-text"><mat-icon>cancel</mat-icon> 不正解...</span>
                  }
                </h3>
                <p>{{ quiz.explanation }}</p>
              </div>
            </mat-card-content>
            <mat-card-actions align="end">
              <button mat-raised-button color="primary" (click)="fetchNewQuiz()">
                次の問題へ <mat-icon>navigate_next</mat-icon>
              </button>
            </mat-card-actions>
          }
        </mat-card>
      }
      @case ('error') {
        <mat-card class="quiz-card error-card">
          <mat-card-header>
            <mat-card-title>エラーが発生しました</mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <p>{{ errorMessage() }}</p>
          </mat-card-content>
          <mat-card-actions align="end">
            <button mat-raised-button color="warn" (click)="fetchNewQuiz()">
              <mat-icon>refresh</mat-icon> 再試行
            </button>
          </mat-card-actions>
        </mat-card>
      }
    }
  </main>
</div>

<!-- [C] Player Score Area -->
<mat-toolbar class="players-area">
  @for (player of playerState.playerList(); track player.id) {
    <div
      class="player-card"
      [class.highlight]="quizState.gameMode() === 'turn' && player.id === playerState.currentPlayer()?.id"
    >
      <span class="player-icon">{{ player.icon }}</span>
      <span class="player-name">{{ player.name }}</span>
      <span class="spacer"></span>

      @if (quizState.gameMode() === 'all') {
        <div class="score-controls">
          <button mat-icon-button (click)="adjustScore(player.id, -1)">
            <mat-icon>remove</mat-icon>
          </button>
          <span class="player-score">{{ player.score }}</span>
          <button mat-icon-button (click)="adjustScore(player.id, 1)">
            <mat-icon>add</mat-icon>
          </button>
        </div>
      } @else {
        <span class="player-score">{{ player.score }}</span>
      }
    </div>
  }
</mat-toolbar>
